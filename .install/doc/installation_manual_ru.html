<html>

<head>
  <title></title>
</head>

<body>
<p><strong>Установка интернет-радио на базе IceCast и Ices на базе сервера с ОС Ubuntu 12.04 LTS</strong></p>
<p></p>
<p><strong>1</strong>) <strong>Предварительные установки</strong></p>
<p>должен быть установлен LAMP-сервер в конфигурации</p>
<p>- Ububntu server 12.04 LTS или выше</p>
<p>- apache 2.2</p>
<p>- PHP 5.3 &ndash; 5.5</p>
<p>- MySQL</p>
<p>Дополнительно устанавливается PHPmyadmin и mc</p>
<p><strong>2</strong>) <strong>Установка сервера вещания потока Icecast2</strong></p>
<p><strong>вариант установки из пакетов (не рекомендуется, т.к. обычно доступна только старая версия) </strong></p>
<p><em>$ apt-get install icecast2</em></p>
<p>По завершении установки появится окно для конфигурации параметров.</p>
<p>Следует ввести</p>
<p>- имя домена</p>
<p>- пароль для подключения к сервису IseCast</p>
<p>- пароль для подключения в режиме релея (сервиса ретрансляции)</p>
<p>- пароль администратора для управления сервисом IseCast через веб-интерфейс</p>
<p>Проверить работу сервера:</p>
<p>запустить</p>
<p><em>$ sudo service icecast2 start</em></p>
<p>После этого можно будет зайти на веб-интерфейс сервера по 8000 порту</p>
<p>Например, http://192.168.0.100:8000</p>
<p><strong>вариант установки со сборкой (рекомендуется)</strong></p>
<p></p>
<p>- установить компилятор</p>
<p><em>$ sudo apt-get install build-essential</em></p>
<p>- установить библиотеки:<br /> libshout-dev, libmp3lame-dev, libxml2-dev, libperl-dev, libmp3-info-perl, libxslt1-dev</p>
<p><em>$ sudo apt-get install libshout-dev libmp3lame-dev libxml2-dev </em><em>libperl</em><em>-dev libmp3-info-perl</em><em> libxslt1-dev</em></p>
<p></p>
<p><em>$ cd /tmp</em></p>
<p><em>$ wget http://downloads.xiph.org/releases/icecast/icecast-2.4.1.tar.gz</em></p>
<p><em>$ tar -zxvf /tmp/icecast-2.4.1.tar.gz</em></p>
<p><em>$ cd icecast-2.4.1</em></p>
<p><em>$ ./</em><em>configure </em></p>
<p><em>$ make</em></p>
<p><em>$ sudo make install</em></p>
<p>Настроить конфигурацию сервера в /usr/local/etc/icecast.xml</p>
<p>указать</p>
<p>- имя домена</p>
<p>- пароль для подключения к сервису IseCast</p>
<p>- пароль для подключения в режиме релея (сервиса ретрансляции)</p>
<p>- пароль администратора для управления сервисом IseCast через веб-интерфейс</p>
<p>Настроить каталог для логов</p>
<p>- создать папку /usr/local/var/log/icecast</p>
<p>- сменить владельца на ices</p>
<p><em>$ sudo chown -R ices:ices </em>/usr/local/var/log/icecast</p>
<p>- разрешить запись в неё</p>
<p><em>$ chmod 0755 </em>/usr/local/var/log/icecast</p>
<p>добавить автозапуск <strong>icecast</strong> при загрузке</p>
<p><em>$ sudo update-rc.d icecast defaults</em></p>
<p><strong>3</strong>) <strong>Установка генератора потока IceS</strong></p>
<p>Следует собрать <strong>Ices</strong> из исходников вручную с поддержкой <strong>mini-perl</strong></p>
<p>- установить компилятор</p>
<p><em>$ sudo apt-get install build-essential</em></p>
<p>- установить библиотеки:<br /> libshout-dev, libmp3lame-dev, libxml2-dev, libperl-dev, libmp3-info-perl <br /> </p>
<p><em>$ sudo apt-get install libshout-dev libmp3lame-dev libxml2-dev </em><em>libperl</em><em>-dev libmp3-info-perl</em></p>
<p>Для вещания в mp3 следует использовать версию <strong>Ices 0.4</strong></p>
<p><em>$ cd /tmp</em></p>
<p><em>$ wget http://downloads.us.xiph.org/releases/ices/ices-0.4.tar.gz</em></p>
<p><em>$ tar -zxvf /tmp/ices-0.4.tar.gz</em></p>
<p><em>$ cd ices-0.4</em></p>
<p><em>$ ./</em><em>configure --with-perl</em></p>
<p><em>$ make</em></p>
<p><em>$ sudo make install</em></p>
<p><strong>4</strong>) <strong>Настройка</strong><strong> Ices<br /> <br /> </strong></p>
<p>- скопировать конфигурационный файл <strong>Ices</strong></p>
<p>.install/config/usr/local/etc/ices.conf в /usr/local/etc/ices.conf</p>
<p>- в секции конфигурационного файла /usr/local/etc/ices.conf</p>
<p>&lt;Password&gt;<strong>hackme</strong>&lt;/Password&gt;</p>
<p>заменить <strong>hackme</strong> на пароль для подключения к сервису <strong>IseCast</strong> (см. п. 2)</p>
<p>- скопировать perl-скрипт для получения треков</p>
<p>из .install/config/usr/local/etc/modules/ices.pm в /usr/local/etc/modules/ices.pm</p>
<p>- скопировать php-скрипт для получения треков</p>
<p>из .install/config/usr/local/etc/modules/nextsong.php в /usr/local/etc/modules/nextsong.php</p>
<p>- установить настройки соедининия с базой данных в /usr/local/etc/modules/nextsong.php</p>
<p>(параметры $config[&lsquo;mysql&rsquo;] &mdash; <strong>host user password database</strong>)</p>
<p>примечание: описание настройки соединения с БД и значения параметров &mdash; см далее (п.8)</p>
<p>- установить настройки локали и временной зоны данных в /usr/local/etc/modules/nextsong.php</p>
<p>(параметры $config[&lsquo;local&rsquo;] &mdash; <strong>locale timezone</strong>)</p>
<p>настроить согласно текущей конфигурации linux-системы</p>
<p>- установить права на выполнение и чтение файлов</p>
<p><em>$ chmod 0555 /usr/local/etc/modules/ices.pm</em></p>
<p><em>$ chmod 0555 /usr/local/etc/modules/nextsong.php</em></p>
<p>- cкопировать скрипт автозапуска Ices</p>
<p>из .install/config/etc/init.d/ices в /etc/init.d/ices</p>
<p>установить права на выполнение и чтение файлов</p>
<p><em>$ </em><em>chmod</em><em> 0775 /</em><em>etc/</em><em>init.</em><em>d/</em><em>ices</em></p>
<p>создать пользователя ices для запуска Ices с ограниченными правами</p>
<p><em>$ sudo useradd -M -r -s /bin/false -c "ices user" ices</em></p>
<p>- создать папку /usr/local/tmp/ices</p>
<p>- сменить владельца на ices</p>
<p><em>$ sudo chown -R ices:ices /usr/local/tmp/ices</em></p>
<p>- разрешить запись в неё</p>
<p><em>$ </em><em>chmod</em><em> 0755 /</em><em>usr</em><em>/</em><em>local/</em><em>tmp</em><em>/</em><em>ices</em></p>
<p>добавить автозапуск <strong>ices</strong> при загрузке</p>
<p><em>$ </em><em>sudo</em> <em>update-</em><em>rc</em><em>.</em><em>d </em><em>ices </em><em>defaults </em></p>
<p><strong><br /> </strong></p>
<p><strong>5</strong>)<strong> Настройка </strong><strong>PHP и </strong><strong>Perl</strong></p>
<p></p>
<p><strong>Установка расширения </strong><strong>scrypt</strong><strong> для </strong><strong>PHP </strong></p>
<p></p>
<p>Установить PECL</p>
<p><em>$ sudo apt-get install php-pear</em></p>
<p><em>$ sudo pecl install scrypt</em></p>
<p>подключить расширение scrypt в PHP</p>
<p>создать файл /etc/php5/apache2/conf.d/scrypt.ini</p>
<p><em>$ sudo touch /etc/php5/apache2/conf.d/scrypt.ini</em></p>
<p>в файле /etc/php5/apache2/conf.d/scrypt.ini</p>
<p>создать запись</p>
<p>extension=scrypt.so</p>
<p>перезапустить apache</p>
<p><em>$ sudo service apache2 restart</em></p>
<p></p>
<p></p>
<p><strong>Установка</strong><strong> модуля</strong><strong> JSON::XS для</strong><strong> Perl </strong></p>
<p>установить Perl модуль JSON::XS</p>
<p><em>$ sudo cpan JSON::XS</em></p>
<p>(возможно, cpan потребует настроить субситему Perl с помощью мастера)</p>
<p></p>
<p><strong><br /> </strong></p>
<p><strong>6</strong>) <strong>Конфигация</strong> <strong>apache (2.2) </strong><strong>c использованием протокола </strong><strong>HTTPS</strong></p>
<p><em>$ </em><em>sudo</em> <em>mkdir</em><em> /</em><em>etc/</em><em>apache2/</em><em>ssl</em></p>
<p>- Сгенерировать самоподписанный SSL-сертификат</p>
<p><em>$ sudo openssl req -x509 -nodes -days 1825 -newkey rsa:4096 -keyout /etc/apache2/ssl/apache_radio.key -out /etc/apache2/ssl/apache_radio.crt</em></p>
<p>программа запросит данные владельца сертификата (расположение, название компании, доменное имя, почту администратора)</p>
<p>следует ввести необходимые данные</p>
<p>- подключить сертификат для виртуального хоста apache</p>
<p>cкопировать конфигурацию apache из</p>
<p>.install/config/etc/apache2/sites-available/radio-ssl в /etc/apache2/sites-available/radio-ssl</p>
<p>Модифицировать в соответствии с рекомендациями на</p>
<p>https://community.qualys.com/blogs/securitylabs/2013/08/05/configuring-apache-nginx-and-openssl-for-forward-secrecy</p>
<p>- pазрешить доступ к панели управления радио по https для apache</p>
<p><em>$ sudo a2ensite radio-ssl</em></p>
<p>- включить SSL в apache</p>
<p><em>$ sudo a2enmod ssl</em></p>
<p>- включить модуль mod_rewrite</p>
<p><em>$ sudo a2enmod rewrite</em></p>
<p>- перезапустить apache</p>
<p><em>$ sudo service apache2 restart</em></p>
<p><strong><br /> </strong></p>
<p><strong>7</strong>)<strong> Установка веб-интерфейса для управления радио</strong></p>
<p>- создать директорию /usr/local/www/radio</p>
<p>- разрешить запись в неё</p>
<p><em>$ </em><em>sudo</em> <em>chmod</em><em> 0777 /</em><em>usr</em><em>/</em><em>local/</em><em>www/</em><em>radio</em></p>
<p>- скопировать дистрибутив целиком в /usr/local/www/radio</p>
<p>- поменять владельца папки /usr/local/www/radio на apache</p>
<p><em>$ sudo chown -R www-data:www-data /usr/local/www/radio</em></p>
<p>- запретить модификацию файлов</p>
<p><em>$ sudo chmod -R 0444 /usr/local/www/radio</em></p>
<p><em>$ sudo find /usr/local/www/radio -type d -exec chmod 755 {} +</em></p>
<p><em>$ sudo find /usr/local/www/radio -type f -name "*.php" -print | xargs chmod 755</em></p>
<p>- перезапустить apache</p>
<p><em>$ sudo service apache2 restart</em></p>
<p>Проверить, что работает интерфейс управления радио</p>
<p>(хост http://192.168.0.100 выбран для примера)</p>
<p>http://192.168.0.100/radio/</p>
<p><strong>Должен выдать сообщение о недоступности базы данных (ошибка 503)</strong></p>
<p></p>
<p><strong>Это ожидаемое поведение. Продолжайте далее, переходите к настройке Базы Данных</strong></p>
<p><strong><br /> </strong></p>
<p><strong>8</strong>) <strong>Установка и настройка базы данных MySQL</strong></p>
<p>- открыть phpMyAdmin <strong>по </strong><strong>https</strong></p>
<p>- создать базу данных <strong>radio</strong></p>
<p>- создать пользователя <strong>radio</strong> c паролем</p>
<p>- дать привилегии пользователю <strong>radio</strong> для выполнения запросов SELECT INSERT UPDATE DELETE для базы данных <strong>radio</strong></p>
<p>- выполнить экспорт sql-таблиц из файла .install/database/radio.sql</p>
<p><strong>Настроить подключение к БД:</strong></p>
<p>- установить настройки соедининия с базой данных в /usr/local/www/radio/config/db_config.php</p>
<p>(параметры $config[&lsquo;mysql&rsquo;] &mdash; <strong>host user password database</strong>)</p>
<p>Проверить, что работает интерфейс управления радио</p>
<p>(хост https://192.168.0.100 выбран для примера)</p>
<p>https://192.168.0.100/radio/</p>
<p></p>
<p><strong>Проверить, что можно войти в панель управления радио</strong></p>
<p>https://192.168.0.100/radio/</p>
<p>используя логин и пароль администратора радио по умолчанию (admin/defaultpassword)<br /> </p>
<p><strong>Важно!</strong></p>
<p></p>
<p><strong>Обязательно сменить пароль пользователя по-умолчанию!</strong></p>
<p></p>
<p><strong>9</strong>)<strong> Настройка дополнительных параметров</strong></p>
<p></p>
<p>- установить настройки локали</p>
<p>и временной зоны данных в /usr/local/www/radio/config/local_config.php</p>
<p>(параметры $config[&lsquo;local&rsquo;] &mdash; <strong>locale timezone</strong>)</p>
<p><br /> настроить согласно текущей конфигурации linux-системы</p>
<p></p>
<p>- установить каталог расположения музыкальных файлов в /usr/local/www/radio/config/media_config.php</p>
<p>$config['media']['media_root_folder'] = <strong>/usr/local/music </strong></p>
<p></p>
<p><strong>Важно!</strong></p>
<p></p>
<p>Каталог расположения музыкальных файлов следует настроить особым образом, если Вы планируете выгружать в него файлы по SFTP &mdash; см. п 10)</p>
<p><strong><br /> </strong></p>
<p><strong>10</strong>) <strong>Настройка каталога для загрузки музыкальных файлов по SFTP</strong></p>
<p>- создать пользователя для работы по SFTP</p>
<p><em>$ sudo groupadd sftponly</em></p>
<p><em>$ sudo useradd -M -N -d /usr/local/music -s /bin/false -G sftponly -c "music uploader SFTP user" user_name</em></p>
<p>где user_name &ndash; имя пользователя для доступа по SFTP</p>
<p>- создать пароль</p>
<p><em>$ sudo passwd user_name</em></p>
<p>где user_name &ndash; имя пользователя для доступа по SFTP</p>
<p>- создать папку /usr/local/music</p>
<p><em>$ sudo mkdir /usr/local/music</em></p>
<p>- поменять владельца на root (все элементы пути!)</p>
<p><em>$ sudo chown</em> <em>root:root</em><em> /usr/local/music</em></p>
<p><em>$ sudo chown</em> <em>root:root</em><em> /usr/local</em></p>
<p><em>$ </em><em>sudo</em> <em>chown</em> <em>root:</em><em>root /</em><em>usr</em></p>
<p>- лишить права на запись</p>
<p><em>$ chmod 0755 /usr/local/music</em></p>
<p><em>$ chmod 0755 /usr/local</em></p>
<p><em>$ chmod 0755 /usr</em></p>
<p></p>
<p>- создать папку /usr/local/music/uploads</p>
<p><em>$ sudo mkdir /usr/local/music/uploads</em></p>
<p>задать права и владельца</p>
<p><em>$ sudo chmod 0755 /usr/local/musi</em><em>c/uploads</em></p>
<p><em>$ sudo chown user_name:users /usr/local/music/uploads</em></p>
<p>где user_name &ndash; имя пользователя для доступа по SFTP</p>
<p><br /> - отредактировать /etc/ssh/sshd_config</p>
<p>заменить</p>
<p>Subsystem sftp /usr/lib/openssh/sftp-server</p>
<p>на</p>
<p>#Subsystem sftp /usr/lib/openssh/sftp-server</p>
<p>Subsystem sftp internal-sftp</p>
<p>и добавить в конец</p>
<p>Match user user_name</p>
<p> ChrootDirectory /usr/local/music</p>
<p> ForceCommand internal-sftp</p>
<p> X11Forwarding no</p>
<p> AllowTcpForwarding no</p>
<p><br /> </p>
<p>- перезапустить SSH</p>
<p><em>$ </em><em>sudo</em> <em>restart </em><em>ssh</em></p>
<p>- подключиться SFTP-клиентом (к примеру, FileZilla)</p>
<p>- выгрузить в папку <strong>uploads</strong> mp3-файлы</p>
<p></p>
<p><strong>- зайти в панель управления радио, обновить медиатеку и проверить, что система видит mp3-файлы и корректно читает теги<br /> <br /> <br /> </strong></p>
<p><strong><br /> </strong></p>
<p><strong>11</strong>) <strong>Настройка планировщика задач cron</strong></p>
<p>Для выполнения операции резервного копирования БД следует создать пользователя MySQL с расширенными привилегиями</p>
<p>- открыть phpMyAdmin <strong>по </strong><strong>https</strong></p>
<p>- создать пользователя <strong>radio_backup</strong> c паролем</p>
<p>- дать привилегии пользователю <strong>radio_</strong><strong>backup</strong> для выполнения запросов SELECT, INSERT, CREATE, DROP, INDEX, ALTER, LOCK TABLES для базы данных <strong>radio</strong></p>
<p>Создать папки для хранения резервных копий</p>
<p>- создать папки</p>
<p><em>$ sudo mkdir /usr/local/backup</em></p>
<p><em>$ sudo mkdir /usr/local/backup/auto</em></p>
<p><em>$ sudo mkdir /usr/local/backup/manual</em></p>
<p>- дать права</p>
<p><em>$ sudo chmod 0755 /usr/local/backup/*</em></p>
<p>Далее следует скопировать скрипты задач cron и установить их.</p>
<p>- создать папку /usr/local/cronjobs</p>
<p>- скопироватьфайлыиз</p>
<p>.install/config/usr/local/cronjobs/radio_cron_schedule_minute.sh</p>
<p>.install/config/usr/local/cronjobs/radio_cron_ices_minute.sh</p>
<p>.install/config/usr/local/cronjobs/radio_cron_backup_minute.sh</p>
<p>.install/config/usr/local/cronjobs/radio_backup_sql_export.sh</p>
<p>.install/config/usr/local/cronjobs/radio_backup_sql_import.sh</p>
<p>в папку /usr/local/cronjobs</p>
<p>- отредактировать файлы</p>
<p>/usr/local/cronjobs/radio_backup_sql_export.sh и /usr/local/cronjobs/radio_backup_sql_import.sh</p>
<p>и прописать в них настройки соединения с базой данных для пользователя <strong>radio_backup</strong></p>
<p>- дать права на выполнение</p>
<p><em>$ </em><em>chmod</em><em> 0755 /</em><em>usr</em><em>/</em><em>local/</em><em>cronjobs</em><em>/*</em></p>
<p>добавить задачу в расписание рута</p>
<p><em>$ sudo crontab -e</em></p>
<p>дописатьвконецфайлазадач</p>
<p>* * * * * /usr/local/cronjobs/radio_cron_schedule_minute.sh</p>
<p>* * * * * /usr/local/cronjobs/radio_cron_ices_minute.sh</p>
<p>* * * * * /usr/local/cronjobs/radio_cron_backup_minute.sh</p>
<p>0 6,18 * * * /usr/local/cronjobs/radio_backup_sql_export.sh auto</p>
<p><strong>Последняя строка настраивает периодичность выполнения задач автоматического сохранения резервной копии базы данных </strong>(в данном случае, каждый день в 6:00 и 18:00 )</p>
<p><strong>12</strong>) <strong>Проверка работоспособности</strong></p>
<p>- проверить, что работает интерфейс управления радио</p>
<p>(хост https://192.168.0.100 выбран для примера)</p>
<p>https://192.168.0.100/radio/</p>
<p>должен открыться интерфейс управления радио</p>
<p>- произвести обновление медиатеки (проверить, что читаются файлы и теги)</p>
<p>- создать тестовый плейлист (динамический, все треки, &mdash; с пустым фильтром)</p>
<p>- поставить плейлист в расписание на прошедшую дату, подождать 1 минуту.</p>
<p>- проверить работу модуля выборки треков для Ices</p>
<p><em>$ php /usr/local/etc/modules/nextsong.php</em></p>
<p>должен выдавать треки согласно результатам отбора плейлиста</p>
<p>- запустить <strong>Ices</strong></p>
<p><em>$ sudo service ices start</em></p>
<p>- проверить отсутствие ошибок</p>
<p>- проверить, что генератор потока присоединился к северу ретрансляции</p>
<p>Зайти на http://192.168.0.100:8000/status.xsl</p>
<p>- должен быть подключен mountpoint <strong>/mystream</strong></p>
<p>прослушать радио, подключившись к потоку <strong>/mystream</strong> с помощью плеера поддерживающего воспроизведение потокового вещания, например, <strong>VLC</strong>/<strong>Winamp</strong></p>
<p>- перезапустить Ices (не выключая воспроизведение радио)</p>
<p><em>$ </em><em>sudo</em><em> service ices restart</em></p>
<p>плеер должен через насколько секунд переключиться на следующий трек</p>
<p></p>
<p>- перезагрузить систему и проверить, что запускаются <strong>Icecast</strong> и <strong>Ices</strong></p>
<p></p>
<p><strong>13</strong>)<strong> После завершения работ по установке и настройке</strong></p>
<p>- Выключить PhpMyAdmin</p>
<p><em>$ sudo a2dissite phpmyadmin</em></p>
<p><em>$ sudo service apache2 restart</em></p>
<p></p>
<p>-Проверить, что phpmyadmin не доступен по URL</p>

</body>

</html>